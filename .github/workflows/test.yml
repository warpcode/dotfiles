---
name: Test Dotfiles
on: [push, pull_request]

jobs:
  test-linux:
    name: test-linux-${{ matrix.container }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container:
          - ubuntu:latest
          - debian:latest
          - fedora:latest
          - archlinux:latest
    container:
      image: ${{ matrix.container }}
      volumes:
        - ${{ github.workspace }}:${{ github.workspace }}
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      # Install required dependencies
      - name: Install dependencies
        container: ${{ matrix.container }}
        run: |
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update -qq && \
              apt-get install -y -qq sudo zsh stow git jq wget curl make
          elif command -v dnf >/dev/null 2>&1; then
            dnf update -y -q && \
              dnf install -y -q sudo zsh stow git jq wget curl make
          elif command -v pacman >/dev/null 2>&1; then
            pacman -Syu --noconfirm --quiet sudo zsh stow git jq wget curl make
          else
            echo "Unsupported package manager"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Configure git to use HTTPS instead of SSH
      - name: Configure git
        container: ${{ matrix.container }}
        run: |
          git config --global \
            url."https://github.com/".insteadOf git@github.com:

      # Configure git to use HTTPS instead of SSH
      - name: Configure git
        run: |
          git config --global \
            url."https://github.com/".insteadOf git@github.com:

      # Install dotfiles using make (as root)
      - name: Install dotfiles
        run: |
          pwd
          ls -al
          make install-generic

      # Install additional dependencies using df.install
      - name: Install additional dependencies
        run: |
          zsh -c '
            source ~/.zshrc
            _installer_install
          '

      # Run tests as root
      - name: Run tests as root
        run: |
          zsh -c '
            # Test configuration loading
            source ~/.zshrc && echo "Config loaded successfully"
            # Test df.install alias availability
            if alias df.install >/dev/null 2>&1; then
              echo "df.install alias is defined"
            else
              echo "df.install alias not found" >&2
              exit 1
            fi
          '

   # test-macos:
   #   runs-on: macos-latest
   #   defaults:
   #     run:
   #       working-directory: ${{ github.workspace }}

   #   steps:
   #     - uses: actions/checkout@v4
   #       with:
   #         fetch-depth: 0

   #     # Configure git to use HTTPS instead of SSH
   #     - name: Configure git
   #       run: |
   #         git config --global \
   #           url."https://github.com/".insteadOf git@github.com:

   #     # Install dotfiles using make (as root)
   #     - name: Install dotfiles
   #       run: |
   #         pwd
   #         ls -al
   #         make install-generic

   #     # Run tests as root
   #     - name: Run tests as root
   #       run: |
   #         zsh -c '
   #           # Test configuration loading
   #           source ~/.zshrc && echo "Config loaded successfully"
   #           # Test df.install alias availability
   #           if alias df.install >/dev/null 2>&1; then
   #             echo "df.install alias is defined"
   #           else
   #             echo "df.install alias not found" >&2
   #             exit 1
   #           fi
   #         '
